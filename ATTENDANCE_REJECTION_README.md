# Fonctionnalit√© de validation et rejet des listes de pr√©sence pour les sous-pr√©fets

## üéØ Objectif

Permettre aux sous-pr√©fets de **valider** ou **rejeter** une liste de pr√©sence, avec des comportements diff√©rents :
- **Validation** : Approuve la liste de pr√©sence
- **Invalidation** : Remet la liste en √©tat "soumis" (pour corrections mineures)
- **Rejet** : Remet la liste en √©tat "brouillon" (pour corrections majeures)

## üîÑ √âtats des listes de pr√©sence

### **Flux des √©tats**
```
BROUILLON (draft) ‚Üí SOUMIS (submitted) ‚Üí VALID√â (validated)
     ‚Üë                    ‚Üë                    ‚Üë
     ‚îî‚îÄ‚îÄ Rejet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ Invalidation ‚îÄ‚îÄ‚îÄ‚îò
```

### **D√©tails des √©tats**
- **`draft`** : Liste en cours de cr√©ation/modification par le secr√©taire
- **`submitted`** : Liste soumise au sous-pr√©fet pour validation
- **`validated`** : Liste approuv√©e par le sous-pr√©fet

## ‚úÖ Impl√©mentation

### 1. **Contr√¥leur Laravel** (`MeetingController.php`)

#### **M√©thode `validateAttendance`** - Valider les pr√©sences
```php
public function validateAttendance(Meeting $meeting)
{
    // V√©rifier si l'utilisateur est un sous-pr√©fet ou admin
    if (!Auth::user()->hasRole(['president', 'President', 'admin', 'Admin'])) {
        return response()->json([
            'message' => 'Vous n\'avez pas les droits pour valider les pr√©sences de cette r√©union.'
        ], 403);
    }

    // V√©rifier si les pr√©sences peuvent √™tre valid√©es
    if ($meeting->attendance_status !== 'submitted') {
        return response()->json([
            'message' => 'Les pr√©sences doivent √™tre soumises avant d\'√™tre valid√©es.'
        ], 400);
    }

    // Mettre √† jour la validation des pr√©sences
    $meeting->update([
        'attendance_status' => 'validated',
        'attendance_validated_at' => now(),
        'attendance_validated_by' => Auth::id(),
    ]);

    // Cr√©er automatiquement une liste de paiement
    // ... logique de cr√©ation de liste de paiement ...

    return response()->json([
        'message' => 'Pr√©sences valid√©es avec succ√®s et liste de paiement g√©n√©r√©e.'
    ]);
}
```

#### **M√©thode `invalidateAttendance`** - Invalider (remet en √©tat soumis)
```php
public function invalidateAttendance(Meeting $meeting)
{
    // V√©rifier si l'utilisateur est un sous-pr√©fet ou admin
    if (!Auth::user()->hasRole(['president', 'president', 'admin', 'Admin'])) {
        return response()->json([
            'message' => 'Vous n\'avez pas les droits pour invalider les pr√©sences de cette r√©union.'
        ], 403);
    }

    // V√©rifier si les pr√©sences peuvent √™tre invalid√©es
    if (!$meeting->isAttendanceValidated()) {
        return response()->json([
            'message' => 'Les pr√©sences ne sont pas valid√©es.'
        ], 400);
    }

    // Mettre √† jour la validation des pr√©sences (remet en √©tat soumis)
    $meeting->update([
        'attendance_status' => 'submitted',
        'attendance_validated_at' => null,
        'attendance_validated_by' => null,
    ]);

    return response()->json([
        'message' => 'Pr√©sences invalid√©es avec succ√®s. La liste est remise en √©tat soumis.'
    ]);
}
```

#### **M√©thode `rejectAttendance`** - Rejeter (remet en √©tat brouillon)
```php
public function rejectAttendance(Meeting $meeting)
{
    // V√©rifier si l'utilisateur est un sous-pr√©fet ou admin
    if (!Auth::user()->hasRole(['president', 'president', 'admin', 'Admin'])) {
        return response()->json([
            'message' => 'Vous n\'avez pas les droits pour rejeter la liste de pr√©sence de cette r√©union.'
        ], 403);
    }

    // V√©rifier si les pr√©sences peuvent √™tre rejet√©es
    if (!$meeting->isAttendanceValidated()) {
        return response()->json([
            'message' => 'Les pr√©sences ne sont pas valid√©es.'
        ], 400);
    }

    // Mettre √† jour la validation des pr√©sences (remet en √©tat brouillon)
    $meeting->update([
        'attendance_status' => 'draft',
        'attendance_validated_at' => null,
        'attendance_validated_by' => null,
        'attendance_submitted_at' => null,
        'attendance_submitted_by' => null,
    ]);

    return response()->json([
        'message' => 'Liste de pr√©sence rejet√©e avec succ√®s. Elle est remise en √©tat brouillon.'
    ]);
}
```

### 2. **Routes** (`routes/web.php`)

```php
// Routes pour la gestion des pr√©sences
Route::post('/{meeting}/validate-attendance', [MeetingController::class, 'validateAttendance'])
    ->name('validate-attendance');
Route::post('/{meeting}/invalidate-attendance', [MeetingController::class, 'invalidateAttendance'])
    ->name('invalidate-attendance');
Route::post('/{meeting}/reject-attendance', [MeetingController::class, 'rejectAttendance'])
    ->name('reject-attendance');
```

### 3. **Composant Vue.js** (`AttendanceValidationButtons.vue`)

#### **Interface utilisateur**
```vue
<template>
  <div class="flex flex-wrap gap-2">
    <!-- Bouton pour valider les pr√©sences -->
    <button
      v-if="canValidateAttendance && !meeting.attendance_validated_at"
      @click="validateAttendance"
      class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
      :disabled="loading"
    >
      <CheckIcon class="h-4 w-4 mr-2" />
      Valider les pr√©sences
    </button>

    <!-- Bouton pour invalider les pr√©sences (remet en √©tat soumis) -->
    <button
      v-if="canInvalidateAttendance && meeting.attendance_validated_at"
      @click="invalidateAttendance"
      class="inline-flex items-center px-4 py-2 bg-orange-600 text-white rounded-md text-sm font-medium hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
      :disabled="loading"
    >
      <ArrowUturnLeftIcon class="h-4 w-4 mr-2" />
      Remettre en √©tat soumis
    </button>

    <!-- Bouton pour rejeter les pr√©sences (remet en √©tat brouillon) -->
    <button
      v-if="canRejectAttendance && meeting.attendance_validated_at"
      @click="rejectAttendance"
      class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
      :disabled="loading"
    >
      <XMarkIcon class="h-4 w-4 mr-2" />
      Rejeter la liste
    </button>

    <!-- Indicateur de validation des pr√©sences -->
    <div v-if="meeting.attendance_validated_at" class="inline-flex items-center px-3 py-2 bg-green-100 text-green-800 rounded-md text-sm font-medium">
      <CheckIcon class="h-4 w-4 mr-2" />
      Pr√©sences valid√©es
      <span class="ml-2 text-xs text-green-600">
        le {{ formatDate(meeting.attendance_validated_at) }}
      </span>
    </div>
  </div>
</template>
```

#### **Logique de permissions**
```javascript
// V√©rifier si l'utilisateur peut valider les pr√©sences
const canValidateAttendance = computed(() => {
  return hasRole(props.user.roles, 'president') || hasRole(props.user.roles, 'admin')
})

// V√©rifier si l'utilisateur peut invalider les pr√©sences
const canInvalidateAttendance = computed(() => {
  return hasRole(props.user.roles, 'president') || hasRole(props.user.roles, 'admin')
})

// V√©rifier si l'utilisateur peut rejeter les pr√©sences
const canRejectAttendance = computed(() => {
  return hasRole(props.user.roles, 'president') || hasRole(props.user.roles, 'admin')
})
```

#### **Fonctions d'action**
```javascript
// Fonction pour valider les pr√©sences
const validateAttendance = async () => {
  if (!canValidate.value) {
    toast.error('Les pr√©sences ne peuvent √™tre valid√©es que si elles ont √©t√© soumises.')
    return
  }

  if (!confirm('√ätes-vous s√ªr de vouloir valider les pr√©sences de cette r√©union ?')) {
    return
  }

  loading.value = true

  try {
    const response = await axios.post(route('meetings.validate-attendance', props.meeting.id))
    
    toast.success(response.data.message || 'Pr√©sences valid√©es avec succ√®s')
    emit('attendanceValidated')
  } catch (error) {
    console.error('Erreur:', error)
    toast.error(error.response?.data?.message || 'Erreur lors de la validation des pr√©sences')
  } finally {
    loading.value = false
  }
}

// Fonction pour invalider les pr√©sences (remet en √©tat soumis)
const invalidateAttendance = async () => {
  if (!confirm('√ätes-vous s√ªr de vouloir remettre les pr√©sences en √©tat soumis ?')) {
    return
  }

  loading.value = true

  try {
    const response = await axios.post(route('meetings.invalidate-attendance', props.meeting.id))
    
    toast.success(response.data.message || 'Pr√©sences invalid√©es avec succ√®s')
    emit('attendanceInvalidated')
  } catch (error) {
    console.error('Erreur:', error)
    toast.error(error.response?.data?.message || 'Erreur lors de l\'invalidation des pr√©sences')
  } finally {
    loading.value = false
  }
}

// Fonction pour rejeter les pr√©sences (remet en √©tat brouillon)
const rejectAttendance = async () => {
  if (!confirm('√ätes-vous s√ªr de vouloir rejeter cette liste de pr√©sence ? Elle sera remise en √©tat brouillon.')) {
    return
  }

  loading.value = true

  try {
    const response = await axios.post(route('meetings.reject-attendance', props.meeting.id))
    
    toast.success(response.data.message || 'Liste de pr√©sence rejet√©e avec succ√®s')
    emit('attendanceRejected')
  } catch (error) {
    console.error('Erreur:', error)
    toast.error(error.response?.data?.message || 'Erreur lors du rejet de la liste de pr√©sence')
  } finally {
    loading.value = false
  }
}
```

### 4. **Int√©gration dans la vue** (`Meetings/Show.vue`)

```vue
<AttendanceValidationButtons 
  :meeting="meeting"
  :user="user"
  @attendance-validated="handleAttendanceValidated"
  @attendance-invalidated="handleAttendanceInvalidated"
  @attendance-rejected="handleAttendanceRejected"
/>
```

#### **Gestion des √©v√©nements**
```javascript
const handleAttendanceValidated = () => {
  // Recharger la page pour mettre √† jour les donn√©es
  window.location.reload()
}

const handleAttendanceInvalidated = () => {
  // Recharger la page pour mettre √† jour les donn√©es
  router.reload()
}

const handleAttendanceRejected = () => {
  // Recharger la page pour mettre √† jour les donn√©es
  router.reload()
}
```

## üîÑ Flux de fonctionnement d√©taill√©

### **1. √âtat initial (brouillon)**
- ‚úÖ **Bouton "Valider les pr√©sences"** : Cach√©
- ‚úÖ **Bouton "Remettre en √©tat soumis"** : Cach√©
- ‚úÖ **Bouton "Rejeter la liste"** : Cach√©
- ‚ùå **Indicateur "Pr√©sences valid√©es"** : Cach√©
- **Action possible** : Le secr√©taire peut modifier la liste

### **2. Apr√®s soumission par le secr√©taire**
- ‚úÖ **Bouton "Valider les pr√©sences"** : Visible (vert)
- ‚úÖ **Bouton "Remettre en √©tat soumis"** : Cach√©
- ‚úÖ **Bouton "Rejeter la liste"** : Cach√©
- ‚ùå **Indicateur "Pr√©sences valid√©es"** : Cach√©
- **Action possible** : Le sous-pr√©fet peut valider

### **3. Apr√®s validation par le sous-pr√©fet**
- ‚ùå **Bouton "Valider les pr√©sences"** : Cach√©
- ‚úÖ **Bouton "Remettre en √©tat soumis"** : Visible (orange)
- ‚úÖ **Bouton "Rejeter la liste"** : Visible (rouge)
- ‚úÖ **Indicateur "Pr√©sences valid√©es"** : Visible avec date
- **Actions possibles** : Le sous-pr√©fet peut invalider ou rejeter

### **4. Apr√®s invalidation (remet en √©tat soumis)**
- ‚úÖ **Bouton "Valider les pr√©sences"** : Visible (vert)
- ‚ùå **Bouton "Remettre en √©tat soumis"** : Cach√©
- ‚ùå **Bouton "Rejeter la liste"** : Cach√©
- ‚ùå **Indicateur "Pr√©sences valid√©es"** : Cach√©
- **Action possible** : Le sous-pr√©fet peut revalider apr√®s corrections

### **5. Apr√®s rejet (remet en √©tat brouillon)**
- ‚ùå **Bouton "Valider les pr√©sences"** : Cach√©
- ‚ùå **Bouton "Remettre en √©tat soumis"** : Cach√©
- ‚ùå **Bouton "Rejeter la liste"** : Cach√©
- ‚ùå **Indicateur "Pr√©sences valid√©es"** : Cach√©
- **Action possible** : Le secr√©taire peut modifier et resoumettre

## üîê Gestion des permissions

### **R√¥les autoris√©s**
- **`president`** : Sous-pr√©fet (peut valider, invalider et rejeter)
- **`admin`** : Administrateur (peut valider, invalider et rejeter)

### **V√©rifications de s√©curit√©**
- **C√¥t√© client** : V√©rification des r√¥les dans le composant Vue
- **C√¥t√© serveur** : V√©rification des r√¥les dans le contr√¥leur Laravel
- **Double protection** : M√™me si le client est modifi√©, le serveur v√©rifie les permissions

## üìä Impact sur les donn√©es

### **Lors de la validation**
- `attendance_status` ‚Üí `'validated'`
- `attendance_validated_at` ‚Üí `now()`
- `attendance_validated_by` ‚Üí `Auth::id()`
- **Cr√©ation automatique** d'une liste de paiement

### **Lors de l'invalidation (remet en √©tat soumis)**
- `attendance_status` ‚Üí `'submitted'`
- `attendance_validated_at` ‚Üí `null`
- `attendance_validated_by` ‚Üí `null`
- **Conservation** de la liste de paiement existante

### **Lors du rejet (remet en √©tat brouillon)**
- `attendance_status` ‚Üí `'draft'`
- `attendance_validated_at` ‚Üí `null`
- `attendance_validated_by` ‚Üí `null`
- `attendance_submitted_at` ‚Üí `null`
- `attendance_submitted_by` ‚Üí `null`
- **Conservation** de la liste de paiement existante

## üé® Interface utilisateur

### **Boutons**
- **Validation** : Bouton vert avec ic√¥ne de validation
- **Invalidation** : Bouton orange avec ic√¥ne de retour (remet en √©tat soumis)
- **Rejet** : Bouton rouge avec ic√¥ne X (remet en √©tat brouillon)
- **√âtats** : Boutons affich√©s/masqu√©s selon le contexte

### **Indicateurs visuels**
- **Pr√©sences valid√©es** : Badge vert avec date de validation
- **Chargement** : Spinner pendant les op√©rations
- **Messages** : Toast notifications de succ√®s/erreur

### **Confirmations**
- **Validation** : "√ätes-vous s√ªr de vouloir valider les pr√©sences de cette r√©union ?"
- **Invalidation** : "√ätes-vous s√ªr de vouloir remettre les pr√©sences en √©tat soumis ?"
- **Rejet** : "√ätes-vous s√ªr de vouloir rejeter cette liste de pr√©sence ? Elle sera remise en √©tat brouillon."

## üöÄ Cas d'usage

### **1. Validation**
- **Quand** : La liste de pr√©sence est correcte et compl√®te
- **R√©sultat** : Cr√©ation automatique de la liste de paiement
- **Action suivante** : Traitement des paiements

### **2. Invalidation (remet en √©tat soumis)**
- **Quand** : Corrections mineures n√©cessaires (orthographe, formatage)
- **R√©sultat** : La liste reste soumise, le secr√©taire peut la corriger
- **Action suivante** : Le secr√©taire corrige et le sous-pr√©fet revalide

### **3. Rejet (remet en √©tat brouillon)**
- **Quand** : Corrections majeures n√©cessaires (participants manquants, erreurs de comptage)
- **R√©sultat** : La liste retourne en brouillon, le secr√©taire peut la modifier compl√®tement
- **Action suivante** : Le secr√©taire refait la liste et la resoumet

## üéØ Avantages de cette impl√©mentation

### **1. Flexibilit√©**
- **Trois niveaux d'action** : Validation, invalidation, rejet
- **Gestion des erreurs** : Diff√©rents niveaux de correction
- **Workflow adaptatif** : S'adapte aux besoins de correction

### **2. S√©curit√©**
- **Double v√©rification** : Permissions v√©rifi√©es c√¥t√© client et serveur
- **Validation des √©tats** : Actions uniquement sur √©tats appropri√©s
- **Messages d'erreur** : Erreurs explicites et appropri√©es

### **3. Exp√©rience utilisateur**
- **Interface intuitive** : Boutons contextuels selon l'√©tat
- **Feedback visuel** : Indicateurs clairs et boutons color√©s
- **Confirmations** : Messages explicites pour √©viter les erreurs

### **4. Tra√ßabilit√©**
- **Historique complet** : Toutes les actions sont trac√©es
- **Horodatage** : Dates pr√©cises des actions
- **Identification** : Utilisateurs responsables identifi√©s

## üìã Tests recommand√©s

### **1. Tests de permissions**
- ‚úÖ **Sous-pr√©fet** : Peut valider, invalider et rejeter
- ‚úÖ **Secr√©taire** : Ne peut ni valider ni invalider ni rejeter
- ‚úÖ **Admin** : Peut valider, invalider et rejeter

### **2. Tests de workflow**
- ‚úÖ **Validation** ‚Üí Boutons d'invalidation et rejet visibles
- ‚úÖ **Invalidation** ‚Üí Bouton de validation visible, √©tat "soumis"
- ‚úÖ **Rejet** ‚Üí Aucun bouton visible, √©tat "brouillon"
- ‚úÖ **√âtats visuels** : Indicateurs corrects selon l'√©tat

### **3. Tests de s√©curit√©**
- ‚úÖ **Validation serveur** : Permissions v√©rifi√©es c√¥t√© serveur
- ‚úÖ **√âtats valides** : Actions uniquement sur √©tats appropri√©s
- ‚úÖ **Messages d'erreur** : Erreurs explicites et appropri√©es

### **4. Tests de donn√©es**
- ‚úÖ **Validation** : Cr√©ation de liste de paiement
- ‚úÖ **Invalidation** : Conservation de la liste de paiement
- ‚úÖ **Rejet** : Conservation de la liste de paiement

## üéâ Conclusion

La fonctionnalit√© de **validation et rejet des listes de pr√©sence** est maintenant **compl√®tement impl√©ment√©e** avec trois niveaux d'action :

### ‚úÖ **Fonctionnalit√©s disponibles**
- **Validation** : Approuve la liste et cr√©e la liste de paiement
- **Invalidation** : Remet en √©tat "soumis" pour corrections mineures
- **Rejet** : Remet en √©tat "brouillon" pour corrections majeures

### üöÄ **Pr√™t √† l'utilisation**
- Les sous-pr√©fets ont un contr√¥le complet sur les listes de pr√©sence
- L'interface s'adapte automatiquement selon l'√©tat
- Toutes les v√©rifications de s√©curit√© sont en place
- L'exp√©rience utilisateur est optimale avec des boutons contextuels

### üîÑ **Workflow flexible**
- **Validation** ‚Üí **Invalidation** ‚Üí **Revalidation** (pour corrections mineures)
- **Validation** ‚Üí **Rejet** ‚Üí **Nouvelle soumission** (pour corrections majeures)

La solution est maintenant op√©rationnelle et offre une gestion compl√®te des listes de pr√©sence ! üéØ‚ú®
